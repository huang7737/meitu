<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta http-equiv="cache-control" content="no-cache">  
<title>图片浏览</title>
<script src="http://apps.bdimg.com/libs/jquery/2.1.4/jquery.js"></script>
</head>
<body>
	<div id="detail"></div>
	<div id="more" style="width:100%;height:50px; background:#ccc;display:none;">更多图片</div>
	<div id="mark" style="width:100%;height:50px;z-index:99;position:absolute;left:0px;top:0px;display:none;">
		<button id="markBtn" style="width:45%;">mark</button>
		<button id="cancelBtn" style="width:45%;">cancel</button>
	</div>
</body>
<script type="text/javascript">
var page=1;
$(document).ready(function(){
	$("#more").click(function(){
		page++;
		showPicture();
	});
	showPicture();
	
	$("#detail").on("click",function(e){
		e.preventDefault();
		if(event.target.nodeName=="IMG"){
			var pos=$(event.target).position();
			var imageId=$(event.target).attr("imageId");
			$("#markBtn").attr("imageId",imageId);
			$("#mark").css("display","block");
			$("#mark").css("left",pos.left+"px");
			$("#mark").css("top",pos.top+"px");
		}
	});
	
	$("#cancelBtn").on("click",function(e){
		e.preventDefault();
		$("#mark").css("display","none");
	});
	
	$("#markBtn").on("click",function(e){
		e.preventDefault();
		$.post("/meitu/app/mark",{imageId:$(this).attr("imageId")}, function(result){
			$("#mark").css("display","none");
		});
	});
});

$(window).scroll(function() {
		var scrollTop = $(this).scrollTop();
		var scrollHeight = $(document).height();
		var windowHeight = $(this).height();
		if (scrollTop + windowHeight >= scrollHeight-5) {
			page++;
			showPicture();
		}
});

$(document).on('touchend',function(e) {
	var scrollTop = $(window).scrollTop();
	var scrollHeight = $(document).height();
	var windowHeight = $(window).height();
	if (scrollTop + windowHeight >= scrollHeight-5) {
		page++;
		showPicture();
	}
});

function showPicture(){
	$.get("/meitu/app/listPicture?pageSize=5&page="+page, function(result){
	    if(!result.dataList||result.dataList.length==0){
	    	$("#more").html("没有其他图片了");
	    	$("#more").unbind("click");
	    }else{
	    	var imgHtml="";
	    	for(var i=0;i<result.dataList.length;i++){
	    		$("#detail").append("<div><img src='"+result.dataList[i].access_url+"' imageId='"+result.dataList[i].imageId+"'/></div>")
	    	}
	    }
	  });
	}
</script>
</html>